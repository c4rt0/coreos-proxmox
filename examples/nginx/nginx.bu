variant: fcos
version: 1.6.0

passwd:
  users:
    - name: core
      home_dir: /var/home/core
      shell: /bin/bash
      groups:
        - wheel
        - docker
      ssh_authorized_keys:
        - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGnKNJUQdGdd8jwuOoI/BHjCvxn0GEctbgVqOPn6GAzo c4rt0gr4ph3r@gmail.com
    - name: fcos-user
      # Password: coreos
      password_hash: $6$pBtiDulPBTRNjxkB$GNWztgj4Ib42fnmUdW7cxUDfk9eH7RdDparNdlm0bAKimHsJN0t4wSriYLKiymME35sbei.O3UrTkSTmyt/rj0
      home_dir: /var/home/fcos-user
      shell: /bin/bash
      groups:
        - wheel
        - docker

systemd:
  units:
    - name: nginx-container.service
      enabled: true
      contents: |
        [Unit]
        Description=nginx Web Server Container
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=notify
        NotifyAccess=main
        Restart=always
        RestartSec=10

        # Pull latest nginx image
        ExecStartPre=/usr/bin/podman pull docker.io/library/nginx:latest

        # Create persistent storage directories
        ExecStartPre=/bin/bash -c 'mkdir -p /var/www/html /etc/nginx/conf.d'

        # Start nginx container with volume mounts
        # Uses host networking - ports 80 and 443 are directly accessible
        # /var/www/html for website content
        # /etc/nginx/conf.d for custom configurations
        ExecStart=/usr/bin/podman run \
          --name nginx-server \
          --network host \
          -v /var/www/html:/usr/share/nginx/html:ro \
          -v /etc/nginx/conf.d:/etc/nginx/conf.d:ro \
          docker.io/library/nginx:latest

        ExecStop=/usr/bin/podman stop -t 10 nginx-server
        ExecStopPost=/usr/bin/podman rm -f nginx-server

        [Install]
        WantedBy=multi-user.target

    - name: nginx-config-setup.service
      enabled: true
      contents: |
        [Unit]
        Description=Setup nginx default content
        Before=nginx-container.service
        ConditionPathExists=!/var/www/html/index.html

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/bin/bash -c "mkdir -p /var/www/html && echo '<html><head><title>Welcome to Nginx on Fedora CoreOS</title></head><body><h1>Welcome to Nginx on Fedora CoreOS</h1><p>If you see this page, Nginx is successfully running on your Fedora CoreOS system.</p></body></html>' > /var/www/html/index.html"

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /etc/motd
      mode: 0644
      overwrite: true
      contents:
        inline: |
          Welcome to Fedora CoreOS with nginx

          nginx container is configured and running.
          
          Access your web server at:
          - HTTP: http://<hostname-or-ip>:80
          - HTTPS: https://<hostname-or-ip>:443 (if configured)
          
          Website content location: /var/www/html/
          nginx config location: /etc/nginx/conf.d/

    # IMPORTANT: Change this hostname if deploying multiple nginx instances!
    # Each instance must have a unique hostname.
    - path: /etc/hostname
      mode: 0644
      overwrite: true
      contents:
        inline: fcos-nginx

    # Networking - DHCP configuration
    # To get your interface name use `ip link`
    - path: /etc/NetworkManager/system-connections/ens18.nmconnection
      mode: 0600
      contents:
        inline: |
          [connection]
          id=ens18
          type=ethernet
          interface-name=ens18

          [ipv4]
          method=auto

          [ipv6]
          method=ignore

    - path: /etc/profile.d/nginx-info.sh
      mode: 0644
      contents:
        inline: |
          echo "nginx Web Server Info:"
          echo "- Container status: \$(podman ps --filter name=nginx-server --format '{{.Status}}')"
          echo "- Configuration directory: /etc/nginx/conf.d"
          echo "- Website root: /var/www/html"
